# Implementation Plan: Add User 8352041023 with Full Access

## Context Analysis

This health tracking Telegram bot uses a subscription-based access control system with the following components:

### Current Authorization System
1. **Database Schema** (`migrations/002_subscription_and_invites.sql`):
   - Users have `subscription_status` field: `pending`, `trial`, `active`, `cancelled`, or `expired`
   - Users have `subscription_tier` field: `free`, `premium`, etc.
   - Authorization checks require `active` or `trial` status

2. **Authorization Flow** (`src/utils/auth.py`):
   - `is_authorized()` checks subscription status in database
   - `is_admin()` hardcodes admin user as `7376426503`
   - Pending/expired users cannot use the bot

3. **User Activation** (`src/db/queries.py::use_invite_code()`):
   - Users activate via invite codes
   - Codes grant subscription tier and trial period
   - Sets `subscription_status` to `active` or `trial`

### User Request
Add phone number `8352041023` as a "full user" (full access = active subscription)

## Implementation Approach

We have **3 possible approaches** to grant full user access:

### Option 1: Direct Database Update (Recommended)
**Pros:**
- Quick and simple
- No code changes needed
- Immediate effect

**Cons:**
- Bypasses invite code system
- Manual SQL operation

**Implementation:**
```sql
-- Ensure user exists
INSERT INTO users (telegram_id) VALUES ('8352041023')
ON CONFLICT (telegram_id) DO NOTHING;

-- Grant active subscription with premium tier
UPDATE users
SET subscription_status = 'active',
    subscription_tier = 'premium',
    subscription_start_date = NOW(),
    activated_at = NOW()
WHERE telegram_id = '8352041023';
```

### Option 2: Create Master Code for User
**Pros:**
- Uses existing invite code system
- Trackable (code usage logged)
- Can be shared if needed

**Cons:**
- Extra step (create code + user enters it)
- Requires user interaction

**Implementation:**
1. Admin creates master code via agent
2. Share code with user 8352041023
3. User runs `/activate <code>` command

### Option 3: Add Admin Management Function
**Pros:**
- Future-proof (reusable for other users)
- Follows bot patterns
- Admin-only tool

**Cons:**
- Requires code changes
- More complex
- Overkill for one user

**Implementation:**
- Add `grant_full_access` tool to agent
- Admin-only permission check
- Updates user subscription directly

## Recommended Solution: Option 1 (Direct Update)

Given the request is for **one specific user** and needs immediate implementation, Option 1 is best.

## Implementation Steps

### Step 1: Create Migration Script
Create `migrations/013_add_full_user_8352041023.sql`:

```sql
-- Migration 013: Add user 8352041023 with full access
-- Purpose: Grant full access to specified user

-- Ensure user exists
INSERT INTO users (telegram_id)
VALUES ('8352041023')
ON CONFLICT (telegram_id) DO NOTHING;

-- Grant active premium subscription
UPDATE users
SET subscription_status = 'active',
    subscription_tier = 'premium',
    subscription_start_date = NOW(),
    activated_at = NOW(),
    invite_code_used = 'admin_grant_8352041023'  -- Track this was admin-granted
WHERE telegram_id = '8352041023';

-- Verify result
SELECT telegram_id, subscription_status, subscription_tier, activated_at
FROM users
WHERE telegram_id = '8352041023';
```

### Step 2: Run Migration
Execute the migration against the database:
```bash
psql $DATABASE_URL -f migrations/013_add_full_user_8352041023.sql
```

### Step 3: Verify Access
Test that user can access the bot:
1. User 8352041023 sends message to bot
2. Bot should respond (not show "pending" error)
3. Check logs for successful authorization

### Step 4: Create User Data Files
Ensure user memory files exist:
```python
# This happens automatically when user first messages bot
# But we can verify via:
await memory_manager.create_user_files('8352041023')
```

## Alternative: Quick SQL Command

For immediate execution without migration file:

```bash
psql $DATABASE_URL -c "
INSERT INTO users (telegram_id) VALUES ('8352041023') ON CONFLICT DO NOTHING;
UPDATE users SET subscription_status = 'active', subscription_tier = 'premium', subscription_start_date = NOW(), activated_at = NOW() WHERE telegram_id = '8352041023';
SELECT telegram_id, subscription_status FROM users WHERE telegram_id = '8352041023';
"
```

## Future Enhancement (Optional)

If adding full users becomes common, consider implementing Option 3:

### Add Admin Tool: `grant_full_access`

**Tool Definition:**
```python
@tool
async def grant_full_access(
    ctx: RunContext[AgentDeps],
    telegram_id: str,
    tier: str = "premium"
) -> ToolResult:
    """
    Grant full access to a user (admin only)

    Args:
        telegram_id: User's Telegram ID
        tier: Subscription tier (default: premium)

    Returns:
        Success/failure message
    """
    # Check if caller is admin
    if not is_admin(ctx.deps.user_id):
        return ToolResult(
            success=False,
            message="❌ This command is admin-only"
        )

    # Grant access
    async with db.connection() as conn:
        async with conn.cursor() as cur:
            # Create user if doesn't exist
            if not await user_exists(telegram_id):
                await create_user(telegram_id)
                await ctx.deps.memory_manager.create_user_files(telegram_id)

            # Grant active subscription
            await cur.execute("""
                UPDATE users
                SET subscription_status = 'active',
                    subscription_tier = %s,
                    subscription_start_date = NOW(),
                    activated_at = NOW(),
                    invite_code_used = %s
                WHERE telegram_id = %s
            """, (tier, f'admin_grant_{telegram_id}', telegram_id))

            await conn.commit()

    return ToolResult(
        success=True,
        message=f"✅ Granted {tier} access to user {telegram_id}"
    )
```

**Usage:**
```
Admin: "Grant full access to user 8352041023"
Bot: Uses grant_full_access tool → User activated
```

## Testing Checklist

After implementation:

- [ ] User 8352041023 exists in database
- [ ] User has `subscription_status = 'active'`
- [ ] User has `subscription_tier = 'premium'`
- [ ] User has `activated_at` timestamp
- [ ] User can send messages to bot
- [ ] Bot responds to user (no authorization error)
- [ ] User memory files created in `/data/8352041023/`

## Rollback Plan

If issues arise, remove access:

```sql
UPDATE users
SET subscription_status = 'pending'
WHERE telegram_id = '8352041023';
```

## Security Considerations

1. **Phone Number Verification**: Ensure 8352041023 is the correct Telegram ID (not phone number)
   - Telegram IDs are numeric but different from phone numbers
   - User must message bot first to get their actual Telegram ID
   - Check logs or database for actual ID

2. **Admin Authorization**: Only admin (7376426503) should run this
   - Direct DB access requires database credentials
   - Keep migration files secure

3. **Audit Trail**: Migration includes `invite_code_used = 'admin_grant_8352041023'`
   - Tracks this was manually granted
   - Distinguishes from invite code activations

## Notes

- **Telegram ID vs Phone Number**: The number `8352041023` is likely a Telegram user ID, not a phone number. Confirm this is the user's actual Telegram ID before proceeding.
- **First Message**: User must message the bot at least once before full functionality is available (creates conversation context)
- **Timezone**: System will auto-detect user's timezone on first message based on their Telegram language
- **Onboarding**: User may still see onboarding flow on first interaction (separate from authorization)

## Implementation Time Estimate

- Option 1 (Direct DB): **5 minutes**
- Option 2 (Master Code): **10 minutes**
- Option 3 (Admin Tool): **30-45 minutes**

## Recommendation Summary

**Implement Option 1** (direct database update) via migration script for immediate, secure, and trackable access grant.
