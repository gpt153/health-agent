version: '3.8'

# Health Agent Docker Compose Configuration
#
# Production Setup (always running):
#   - postgres: Database accessible at localhost:5436
#   - health-agent-bot: Telegram bot (RUN_MODE=bot)
#
# Development Setup (RECOMMENDED):
#   - Keep postgres + health-agent-bot running
#   - Run API natively: RUN_MODE=api python -m src.main
#   - See DEVELOPMENT.md for details

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: health_agent
    ports:
      - "5436:5432"  # Host:Container - Use localhost:5436 from native dev environment
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis Cache (for performance optimization)
  # Used for caching user preferences, nutrition data, and conversation history
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Production Telegram Bot (always running)
  # Polls Telegram API for user messages
  # RUN_MODE=bot ensures no conflicts with dev API
  health-agent-bot:
    build: .
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/health_agent
      REDIS_URL: redis://redis:6379/0
      DATA_PATH: /app/data
      RUN_MODE: bot  # bot, api, or both
    env_file:
      - .env.production
    volumes:
      - ./production/data:/app/data
      - ./production/logs:/app/logs
    restart: unless-stopped

  # Optional: API Server (Docker mode)
  # For CI/testing only - developers should run natively for hot reload
  # See DEVELOPMENT.md for native setup instructions
  health-agent-api:
    build: .
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/health_agent
      REDIS_URL: redis://redis:6379/0
      DATA_PATH: /app/data
      RUN_MODE: api
      API_HOST: 0.0.0.0
      API_PORT: 8080
    env_file:
      - .env.production
    ports:
      - "8080:8080"
    volumes:
      - ./production/data:/app/data
      - ./production/logs:/app/logs
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
